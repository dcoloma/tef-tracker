<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html" manifest="application.appcache">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, maximum-scale=1">

    <link href="css/modern.css" rel="stylesheet">
    <link href="css/modern-responsive.css" rel="stylesheet">
    <!--<link href="css/site.css" rel="stylesheet" type="text/css">-->

    <script type="text/javascript" src="js/assets/jquery-1.9.0.min.js"></script>
    <script type="text/javascript" src="js/bugzilla.js"></script>
    <script type='text/javascript' src='js/firebase.js'></script>
    <script type='text/javascript' src="js/async_storage.js"></script>

    <title>Firefox OS Dashboard - Telef√≥nica</title>
</head>
<body class="modern-ui" background="#FFFFFF" >


<script>
// Stores all Dom Nodes that are going to be udpated through FB if connection or through asyncstorage if no connnection
var domnodes = ["UserStories/1_2/P1/OPEN", "UserStories/1_2/P1/CLOSED", "UserStories/1_2/P2/OPEN", "UserStories/1_2/P2/CLOSED",
                  "UserStories/1_3/P1/OPEN", "UserStories/1_3/P1/CLOSED", "UserStories/1_3/P2/OPEN", "UserStories/1_3/P2/CLOSED",
                  "blockers/1_2/all", "blockers/1_2/Gaia", "blockers/1_2/platform",
                  "blockers/1_3/all", "blockers/1_3/Gaia", "blockers/1_3/platform",
                  "blockers/1_4/all", "blockers/1_4/Gaia", "blockers/1_4/platform",];

// Store FB nodes
var nodes = ["UserStories/1_2/P1/",
             "UserStories/1_2/P2/",
             "UserStories/1_3/P1/",
             "UserStories/1_3/P2/",
             "blockers/1_2/",
             "blockers/1_3/",
             "blockers/1_4/"];

var regions = ["index", "stable", "develop", "plan"];

linkPlan = ["https://bugzilla.mozilla.org/buglist.cgi?bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&f1=cf_blocking_b2g&o1=equals&query_format=advanced&v1=1.4%2B",
"https://bugzilla.mozilla.org/buglist.cgi?f1=cf_blocking_b2g&o1=equals&query_format=advanced&bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&v1=1.4%2B&v2=Gaia&o2=anywords&f2=component",
"https://bugzilla.mozilla.org/buglist.cgi?f1=cf_blocking_b2g&o1=equals&query_format=advanced&bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&v1=1.4%2B&v2=Gaia&o2=nowords&f2=component"]

linkDevelop = [
"https://bugzilla.mozilla.org/buglist.cgi?resolution=FIXED&bug_status=RESOLVED&bug_status=VERIFIED&bug_status=CLOSED&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%201.3%3Ap1",
"https://bugzilla.mozilla.org/buglist.cgi?resolution=---&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%201.3%3Ap1",
"https://bugzilla.mozilla.org/buglist.cgi?resolution=FIXED&bug_status=RESOLVED&bug_status=VERIFIED&bug_status=CLOSED&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%201.3%3Ap2",
"https://bugzilla.mozilla.org/buglist.cgi?resolution=---&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%201.3%3Ap2",
"https://bugzilla.mozilla.org/buglist.cgi?bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&f1=cf_blocking_b2g&o1=equals&query_format=advanced&v1=1.3%2B",
"https://bugzilla.mozilla.org/buglist.cgi?f1=cf_blocking_b2g&o1=equals&query_format=advanced&bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&v1=1.3%2B&v2=Gaia&o2=anywords&f2=component",
"https://bugzilla.mozilla.org/buglist.cgi?f1=cf_blocking_b2g&o1=equals&query_format=advanced&bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&v1=1.3%2B&v2=Gaia&o2=nowords&f2=component"
]


linkStable = [
"https://bugzilla.mozilla.org/buglist.cgi?resolution=FIXED&bug_status=RESOLVED&bug_status=VERIFIED&bug_status=CLOSED&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%20koi%3Ap1",
"https://bugzilla.mozilla.org/buglist.cgi?resolution=---&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%20koi%3Ap1",
"https://bugzilla.mozilla.org/buglist.cgi?resolution=FIXED&bug_status=RESOLVED&bug_status=VERIFIED&bug_status=CLOSED&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%20koi%3Ap2",
"https://bugzilla.mozilla.org/buglist.cgi?resolution=---&status_whiteboard_type=allwordssubstr&query_format=advanced&status_whiteboard=ucid%3A%20koi%3Ap2",
"https://bugzilla.mozilla.org/buglist.cgi?bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&f1=cf_blocking_b2g&o1=equals&query_format=advanced&v1=koi%2B",
"https://bugzilla.mozilla.org/buglist.cgi?f1=cf_blocking_b2g&o1=equals&query_format=advanced&bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&v1=koi%2B&v2=Gaia&o2=anywords&f2=component",
"https://bugzilla.mozilla.org/buglist.cgi?f1=cf_blocking_b2g&o1=equals&query_format=advanced&bug_status=UNCONFIRMED&bug_status=NEW&bug_status=ASSIGNED&bug_status=REOPENED&v1=koi%2B&v2=Gaia&o2=nowords&f2=component"
]

idStable = ["UserStories/1_2/P1/CLOSED", "UserStories/1_2/P1/OPEN", "UserStories/1_2/P2/CLOSED", 
             "UserStories/1_2/P2/OPEN", "blockers/1_2/all", "blockers/1_2/Gaia", "blockers/1_2/platform"];
idDevelop = ["UserStories/1_3/P1/CLOSED", "UserStories/1_3/P1/OPEN", "UserStories/1_3/P2/CLOSED", 
             "UserStories/1_3/P2/OPEN", "blockers/1_3/all", "blockers/1_3/Gaia", "blockers/1_3/platform"];
idPlan = ["blockers/1_4/all", "blockers/1_4/Gaia", "blockers/1_4/platform"];
names = ["P1 User Stories Closed", "P1 User Stories Open", "P2 User Stories Closed", "P2 User Stories Open",  
        "Total Blockers", "Gaia Blockers", "Platform Blockers"];

// FB Base URL 
var baseURL = "https://owd.firebaseio.com/";

$(window).ready(function() {
  console.log("window ready");
  fill("1.2", "stable", linkStable, idStable, names, "bg-color-blue", "bg-color-blueDark");
  fill("1.3", "develop", linkDevelop, idDevelop, names, "bg-color-pink", "bg-color-pinkDark");
  fill("1.4", "plan", linkPlan, idPlan, ["Total Blockers", "Gaia Blockers", "Platform Blockers"], "bg-color-yellow", "bg-color-yellow");
  
  showElement('index');
  readFromLS();
  if (navigator.online)
    readFromFB();
});  

// Retrieves information from Local Storage
function readFromLS()
{
  console.log("*** METHOD readFromLS");
  for (var x in domnodes)
  {
    console.log("--- readFromLS var " + domnodes[x]);
    asyncStorage.getItem(domnodes[x], function(value){if (value!=null){document.getElementById(domnodes[x]).innerHTML = value; console.log("--- readFromLS value " + value);} else{console.log("value is null for " + domnodes[x])}});
  }
}

// Retrieves information from Firebase
function readFromFB()
{
  console.log("*** METHOD readFromFB");
  for (var x in nodes)
  {
    fb = new Firebase(baseURL + nodes[x]);
    fb.on('value', createFirebaseCB(nodes[x]));
  }
}

// Closure for adding listeners to every node
function createFirebaseCB(node)
{
  return function(snapshot){
    snapshot.forEach(function(childSnapshot) {
      console.log("*** METHOD FirebaseCB: Item " + node + childSnapshot.name() + " value " + childSnapshot.val());
      asyncStorage.setItem(node + childSnapshot.name(),childSnapshot.val()); 
      var d = document.getElementById(node + childSnapshot.name());
      if (d != null)
        d.innerHTML = "<h1>"+childSnapshot.val()+"</h1>";
    });
  }
}

// Menu handler
function showElement(elementToShow)
{
  for (var element in regions)
  { 
    if(regions[element] == elementToShow)
    {
      document.getElementById(elementToShow).style.visibility="visible";
      document.getElementById(elementToShow).style.display="inline-block";
    }
    else
    {
      document.getElementById(regions[element]).style.visibility="hidden";
      document.getElementById(regions[element]).style.display="none";
    }
  }
}

// Creates DOM Structure for the 3 versions
function fill(version, tag, links, ids, names, color, colorDark)
{
  var wrapper= document.createElement('div');
  wrapper.setAttribute("class", "page-region");
  wrapper.setAttribute("align", "center");
  wrapper.setAttribute("id", tag);

  content = "<div class='page-region-content'>";
  for (var x in links)
  {
    content+= "<a href='" +  links[x]  + "' target='_blank'>";
    content+= "<div class='tile ";
    if (ids[x].substring(0, 8) == "blockers")
     content += color + " icon'><b class='check'></b>";
    else
     content += colorDark + " icon'><b class='check'></b>";
    content+= "<div class='tile-content' id='" + ids[x] + "''></div>";
    content+= "<div class='brand'><span class='name'>" + version + " " + names[x]
    content+= "</span><span class='badge'></span></div></div></a>"
  }  
  content += "</div>"
  wrapper.innerHTML = content;
  document.getElementById("page-index").appendChild(wrapper);
}


</script>
 
<style>
body {background: #1d1d1d;}
.page {background: #1d1d1d;}
</style>

<div class="page" id="page-index">

  <div class="page-header">
     <div class="page-header-content fg-color-white" id="title">
       <a href="javascript:showElement('index')">
       <i class="icon-home fg-color-white"></i>
       </a>
       <h2 class="fg-color-white">FirefoxOS Dashboard</h2>
     </div>
  </div>
  
  <div class="page-region" align="center" id="index">
    <div class="page-region-content">
      <a href="javascript:showElement('stable')">
        <div class="tile bg-color-orange icon">
          <b class="check"></b>
          <div class="tile-content">
          <img src="images/Firefox-stable.png"></img>
          </div>
          <div class="brand">
          <span class="name">
          1.2 (Stabilizing)
          </span>
          <span class="badge">
          </span>
          </div>
        </div>
      </a>
      <a href="javascript:showElement('develop')">
        <div class="tile bg-color-orange icon">
          <b class="check"></b>
          <div class="tile-content">
          <img src="images/Firefox-develop.png"></img>
          </div>
          <div class="brand">
          <span class="name">
          1.3 (Development)
          </span>
          <span class="badge">
          </span>
          </div>
        </div>
      </a>
      <a href="javascript:showElement('plan')">
        <div class="tile bg-color-orange icon">
          <b class="check"></b>
          <div class="tile-content">
          <img src="images/Firefox-plan.png"></img>
          </div>
          <div class="brand">
          <span class="name">
          1.4 (Planning)
          </span>
          <span class="badge">
          </span>
          </div>
        </div>
      </a>

    </div> <!-- page region content -->
  </div> <!-- page region -->


</div><!--page-->

  </body>
</html>
